#!/usr/bin/env python
ondemand_dhcp_http_script_b64="IyEvdXNyL2Jpbi9lbnYgcHl0aG9uCgppbXBvcnQgc3lzCmltcG9ydCB0ZW1wZmlsZQoKc3lzLnBhdGguYXBwZW5kKCcvcGtnL2JpbicpCmZyb20genRwX2hlbHBlciBpbXBvcnQgWnRwSGVscGVycwppbXBvcnQgc29ja2V0CmZyb20gY29udGV4dGxpYiBpbXBvcnQgY2xvc2luZwppbXBvcnQgb3MsIHBvc2l4cGF0aCwgc3VicHJvY2VzcwppbXBvcnQgdGltZSwganNvbgppbXBvcnQgYXJncGFyc2UKZnJvbSBjdHlwZXMgaW1wb3J0IGNkbGwKbGliYyA9IGNkbGwuTG9hZExpYnJhcnkoJ2xpYmMuc28uNicpCl9zZXRucyA9IGxpYmMuc2V0bnMKQ0xPTkVfTkVXTkVUID0gMHg0MDAwMDAwMAoKCgpMSUdIVFRQRF9TWVNWSU5JVD0iIiIKIyEvYmluL3NoCiMKIyAvZXRjL2luaXQuZC9saWdodHRwZF96dHAKIyBTdWJzeXN0ZW0gZmlsZSBmb3IgbGlnaHR0cGQgRGFlbW9uIGZvciBaVFAKIyBjaGtjb25maWc6IDIzNDUgOTUgMDUKIyBkZXNjcmlwdGlvbjogTGlnaHR0cGQgWlRQIERhZW1vbgojCiMgcHJvY2Vzc25hbWU6IGxpZ2h0dHBkX3p0cCAKIyBwaWRmaWxlOiAvdmFyL3J1bi9saWdodHRwZF96dHAucGlkCgpOQU1FPSJsaWdodHRwZF96dHAiClBBVEg9L3NiaW46L2JpbjovdXNyL3NiaW46L3Vzci9iaW4KUElERklMRT0vdmFyL3J1bi8kTkFNRS5waWQKREFFTU9OPS91c3Ivc2Jpbi9saWdodHRwZApERVNDPSJMaWdodHRwZCBXZWIgU2VydmVyIgpPUFRTPSItZiAvbWlzYy9kaXNrMS9saWdodHRwZF96dHAuY29uZiIKREFFTU9OX1VTRVI9InJvb3QiClZSRj0iZ2xvYmFsLXZyZiIKCmRvX3N0YXJ0KCkgewogICAgICAgICMgUmV0dXJuCiAgICAgICAgIyAgIDAgaWYgZGFlbW9uIGhhcyBiZWVuIHN0YXJ0ZWQKICAgICAgICAjICAgMSBpZiBkYWVtb24gd2FzIGFscmVhZHkgcnVubmluZwogICAgICAgICMgICAyIGlmIGRhZW1vbiBjb3VsZCBub3QgYmUgc3RhcnRlZAogICAgZWNobyAiU3RhcnRpbmcgbGlnaHR0cGQgenRwIHNlcnZlciIKICAgICAgICBpZiBbIC1mICRQSURGSUxFIF07IHRoZW4KICAgICAgICAgICAgZWNobyAiTGlnaHR0cGQgenRwIHNlcnZlciBhbHJlYWR5IHJ1bm5pbmcgOiBzZWUgJFBJREZJTEUuIEN1cnJlbnQgUElEOiAkKGNhdCAkUElERklMRSkiCiAgICAgICAgICAgIHJldHVybiAxCiAgICAgICAgZmkKCiAgICAgICAgaXAgbmV0bnMgZXhlYyAkVlJGIHN0YXJ0LXN0b3AtZGFlbW9uIC0tc3RhcnQgLS1tYWtlLXBpZGZpbGUgIFwKICAgICAgICAgICAgICAgICAgICAgICAgICAtLWJhY2tncm91bmQgXAogICAgICAgICAgICAgICAgICAgICAgICAgIC0tcGlkZmlsZSAkUElERklMRSAtLXF1aWV0IFwKICAgICAgICAgICAgICAgICAgICAgICAgICAtLXVzZXIgJERBRU1PTl9VU0VSIFwKICAgICAgICAgICAgICAgICAgICAgICAgICAtLXN0YXJ0YXMgJERBRU1PTiAtLSAkT1BUUyBcCiAgICAgICAgICAgICAgICAgICAgICAgICAgfHwgcmV0dXJuIDIKCiAgICAgICAgZWNobyAiT0siCn0KCmRvX3N0b3AoKSB7CiAgICAgICAgIyBSZXR1cm4KICAgICAgICAjICAgMCBpZiBkYWVtb24gaGFzIGJlZW4gc3RvcHBlZAogICAgICAgICMgICAxIGlmIGRhZW1vbiB3YXMgYWxyZWFkeSBzdG9wcGVkCiAgICAgICAgIyAgIDIgaWYgZGFlbW9uIGNvdWxkIG5vdCBiZSBzdG9wcGVkCiAgICAgICAgIyAgIG90aGVyIGlmIGEgZmFpbHVyZSBvY2N1cnJlZAogICAgICAgIGlwIG5ldG5zIGV4ZWMgJFZSRiBzdGFydC1zdG9wLWRhZW1vbiAtLXNpZ25hbCBTSUdURVJNIFwKICAgICAgICAgICAgICAgICAgICAgICAgICAtLXN0b3AgLS1xdWlldCBcCiAgICAgICAgICAgICAgICAgICAgICAgICAgLS1yZXRyeT1URVJNLzMwL0tJTEwvNSBcCiAgICAgICAgICAgICAgICAgICAgICAgICAgLS1va25vZG8gXAogICAgICAgICAgICAgICAgICAgICAgICAgIC0tcGlkZmlsZSAkUElERklMRSAtLSAkT1BUUwogICAgICAgIFJFVFZBTD0iJD8iCiAgICAgICAgWyAiJFJFVFZBTCIgPSAyIF0gJiYgcmV0dXJuIDIKCiAgICAgICAgcm0gLWYgJFBJREZJTEUKICAgICAgICByZXR1cm4gIiRSRVRWQUwiCiAgICAgICAgICBlY2hvICJPSyIKfQoKCmNhc2UgIiQxIiBpbgogIHN0YXJ0KQogICAgICBkb19zdGFydAogICAgICBjYXNlICIkPyIgaW4KICAgICAgICAgIDB8MSkgZWNobyAtbmUgIkxpZ2h0dHBkIHp0cCBzZXJ2ZXIgc3RhcnRlZCBzdWNjZXNzZnVsbHlcbiIgIDs7CiAgICAgICAgICAyKSBlY2hvIC1uZSAiRmFpbGVkIHRvIHN0YXJ0IGxpZ2h0dHBkIHp0cCBzZXJ2ZXIgXG4iIDs7CiAgICAgIGVzYWMKICAgICAgOzsKICBzdG9wKQogICAgICBkb19zdG9wCiAgICAgIGNhc2UgIiQ/IiBpbgogICAgICAgICAgMHwxKSBlY2hvIC1uZSAiTGlnaHR0cGQgenRwIHNlcnZlciBzdG9wcGVkIHN1Y2Nlc3NmdWxseVxuIiAgOzsKICAgICAgICAgIDIpIGVjaG8gLW5lICJGYWlsZWQgdG8gc3RvcCBsaWdodHRwZCB6dHAgc2VydmVyIFxuIiA7OwogICAgICBlc2FjCiAgICAgIDs7CiAgcmVzdGFydHxmb3JjZS1yZWxvYWQpCiAgICAgIGVjaG8gIlJlc3RhcnRpbmcgJERFU0MiICIkTkFNRSIKICAgICAgZG9fc3RvcAogICAgICBjYXNlICIkPyIgaW4KICAgICAgICAgIDB8MSkKICAgICAgICAgICAgICBlY2hvIC1uZSAiTGlnaHR0cGQgWlRQIFNlcnZlciAgc3RvcHBlZCBzdWNjZXNzZnVsbHkuXG4iCiAgICAgICAgICAgICAgZG9fc3RhcnQKICAgICAgICAgICAgICBjYXNlICIkPyIgaW4KICAgICAgICAgICAgICAgICAgMHwxKSBlY2hvICJMaWdodHRwZCBaVFAgU2VydmVyIHN0YXJ0ZWQgc3VjY2Vzc2Z1bGx5IiAgOzsKICAgICAgICAgICAgICAgICAgKikgZWNobyAiRmFpbGVkIHRvIHN0YXJ0IExpZ2h0dHBkIHp0cCBzZXJ2ZXIgIiA7OyAjIEZhaWxlZCB0byBzdGFydAogICAgICAgICAgICAgIGVzYWMKICAgICAgICAgICAgICA7OwogICAgICAgICAgKikKICAgICAgICAgICAgICAjIEZhaWxlZCB0byBzdG9wCiAgICAgICAgICAgICAgZWNobyAiRmFpbGVkIHRvIHN0b3AgTGlnaHR0cGQgenRwIHNlcnZlciIKICAgICAgICAgICAgICBleGl0IDEKICAgICAgICAgIDs7CiAgICAgIGVzYWMKICAgICAgOzsKICAqKQogICAgTj0vZXRjL2luaXQuZC8kTkFNRQogICAgZWNobyAiVXNhZ2U6ICROIHtzdGFydHxzdG9wfHJlc3RhcnR8Zm9yY2UtcmVsb2FkfSIgPiYyCiAgICBleGl0IDEKICAgIDs7CmVzYWMKZXhpdCAwCiIiIgoKCkxJR0hUVFBEX1NZU1RFTUQ9IiIiCiMgbGlnaHR0cGQgc3lzdGVtZCBzZXJ2aWNlIGZpbGUKIwojIENvcHlyaWdodCAoYykgMjAxOC0yMDIwIGJ5IENpc2NvIFN5c3RlbXMsIEluYy4KIwoKW1VuaXRdCkRlc2NyaXB0aW9uPUxpZ2h0bmluZyBGYXN0IFdlYnNlcnZlciBXaXRoIExpZ2h0IFN5c3RlbSBSZXF1aXJlbWVudHMKQWZ0ZXI9eHItaW5zdGFsbC5zZXJ2aWNlCgpbU2VydmljZV0KIyBUaGUgYm9vdHVwX2ZwZF91cGdyYWRlIHV0aWxpdHkgcmVxdWlyZXMgY29va2llIGNvbmZpZ3VyYXRpb24gYmVmb3JlCiMgeHItaW5zdGFsbCBzZXJ2aWNlLiAgVGhpcyByZXF1aXJlcyB0aGUgbGlnaHR0cGQgc2VydmVyIHRvIGJlIHN0YXJ0ZWQKIyBiZWZvcmUgdGhlIHhyLWluc3RhbGwgc2VydmljZS4gIEhvd2V2ZXIsIENTQ3ZzNTg5ODQgbWVhbnMgdGhhdCB0aGVyZSdzIAojIG5vIHdheSB0byBtb3ZlIHRoZSBsaWdodHRwZCBzZXJ2aWNlIGVhcmxpZXIuICBUbyB3b3JrYXJvdW5kIHRoaXMsIHRoZQojIGxpZ2h0dHBkIHNlcnZpY2UgaXMgc3RhcnRlZCBmcm9tIHhyLWluc3RhbGwgbWFudWFsbHkuCiMKRXhlY1N0YXJ0UHJlPS91c3IvYmluL2VudiBpcCBuZXRucyBleGVjIGdsb2JhbC12cmYgL3Vzci9zYmluL2xpZ2h0dHBkIC10IC1mIC9taXNjL2Rpc2sxL2xpZ2h0dHBkX3p0cC5jb25mCkV4ZWNTdGFydD0vdXNyL2Jpbi9lbnYgaXAgbmV0bnMgZXhlYyBnbG9iYWwtdnJmIC91c3Ivc2Jpbi9saWdodHRwZCAtRCAtZiAvbWlzYy9kaXNrMS9saWdodHRwZF96dHAuY29uZgpFeGVjUmVsb2FkPS9iaW4va2lsbCAtSFVQICRNQUlOUElEClJlc3RhcnQ9b24tZmFpbHVyZQoKW0luc3RhbGxdCldhbnRlZEJ5PW11bHRpLXVzZXIudGFyZ2V0CiIiIgoKCmNsYXNzIFNoaWZ0WlRQU2VydmVyKFp0cEhlbHBlcnMpOgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLAogICAgICAgICAgICAgICAgIHN5c2xvZ19maWxlPU5vbmUsCiAgICAgICAgICAgICAgICAgc3lzbG9nX3NlcnZlcj1Ob25lLAogICAgICAgICAgICAgICAgIHN5c2xvZ19wb3J0PU5vbmUpOgoKICAgICAgICBzdXBlcihTaGlmdFpUUFNlcnZlciwgc2VsZikuX19pbml0X18oc3lzbG9nX2ZpbGU9c3lzbG9nX2ZpbGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN5c2xvZ19zZXJ2ZXI9c3lzbG9nX3NlcnZlciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3lzbG9nX3BvcnQ9c3lzbG9nX3BvcnQpCgogICAgICAgIHNlbGYucm9vdF9scl91c2VyID0gInp0cC11c2VyIgoKICAgICAgICB4cl9hcmNoX2NoZWNrID0gc2VsZi5nZXRYckFyY2goKQogICAgICAgIGlmIHhyX2FyY2hfY2hlY2tbInN0YXR1cyJdID09ICJzdWNjZXNzIjoKICAgICAgICAgICAgc2VsZi54cl9hcmNoID0geHJfYXJjaF9jaGVja1sib3V0cHV0Il0KICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLnN5c2xvZ2dlci5pbmZvKCJGYWlsZWQgdG8gR2V0IFhSIGFyY2gsIGRlZmF1bHRpbmcgdG8gWFIiKQogICAgICAgICAgICBzZWxmLnhyX2FyY2ggPSAiWFIiCgogICAgICAgIAogICAgICAgIHNlbGYuZGhjcF9zZXJ2ZXJfY29uZmlnX2xpc3Q9W10KCgoKICAgIGRlZiBzZXRfbGlnaHR0cGRfY29uZmlnKHNlbGYsIHBvcnQ9ODA4MCwgc2VydmVyX3Jvb3Q9Ii9taXNjL2Rpc2sxL3p0cCIpOgogICAgICAgIHNlbGYuaHR0cGRfcG9ydD1pbnQocG9ydCkKICAgICAgICBzZWxmLmh0dHBkX3NlcnZlcl9yb290PXNlcnZlcl9yb290CgogICAgICAgIHNlbGYubGlnaHR0cGRfY29uZmlnPSIiIgogICAgICAgICMgQ29weXJpZ2h0IChjKSAyMDE4LTIwMTkgYnkgQ2lzY28gU3lzdGVtcywgSW5jLgogICAgICAgICMgQWxsIHJpZ2h0cyByZXNlcnZlZC4KICAgICAgICBzZXJ2ZXIucG9ydCAgICAgICAgICAgICAgICAgPSB7bGlnaHR0cGRfcG9ydH0KICAgICAgICBzZXJ2ZXIubW9kdWxlcyAgICAgICAgICAgICAgPSAoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAibW9kX2FjY2VzcyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAibW9kX2FjY2Vzc2xvZyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAibW9kX2Rpcmxpc3RpbmciICkKICAgICAgICBzZXJ2ZXIuZG9jdW1lbnQtcm9vdCAgICAgICAgPSAie2xpZ2h0dHBkX3NlcnZlcl9yb290fSIKICAgICAgICBzZXJ2ZXIuZXJyb3Jsb2cgICAgICAgICAgICAgPSAiL3Zhci9sb2cvenRwLmxpZ2h0dHBkLmVycm9yLmxvZyIKICAgICAgICBhY2Nlc3Nsb2cuZmlsZW5hbWUgICAgICAgICAgPSAiL3Zhci9sb2cvenRwLmxpZ2h0dHBkLmFjY2Vzcy5sb2ciCiAgICAgICAgZGVidWcubG9nLXJlcXVlc3QtaGFuZGxpbmcgID0gImRpc2FibGUiCiAgICAgICAgdXJsLmFjY2Vzcy1kZW55ICAgICAgICAgICAgID0gKCAifiIsICIuaW5jIiApCiAgICAgICAgc2VydmVyLnBpZC1maWxlICAgICAgICAgICAgID0gIi92YXIvcnVuL2xpZ2h0dHBkX3p0cC5waWQiCiAgICAgICAgI2luZGV4LWZpbGUubmFtZXMgICAgICAgICAgICA9ICggImluZGV4LnR4dCIgKQogICAgICAgIGRpci1saXN0aW5nLmFjdGl2YXRlICAgICAgICA9ICJlbmFibGUiICMgRW5hYmxlIHJlY3Vyc2l2ZSBnZXQKICAgICAgICAiIiIuZm9ybWF0KGxpZ2h0dHBkX3BvcnQ9c2VsZi5odHRwZF9wb3J0LCAKICAgICAgICAgICAgICAgICAgIGxpZ2h0dHBkX3NlcnZlcl9yb290PXNlbGYuaHR0cGRfc2VydmVyX3Jvb3QpCgogICAgICAgIHRyeToKICAgICAgICAgICAgb3MucmVtb3ZlKCIvbWlzYy9kaXNrMS9saWdodHRwZF96dHAuY29uZiIpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLnN5c2xvZ2dlci5pbmZvKCJGYWlsZWQgdG8gcmVtb3ZlIGxpZ2h0dHBkX2NvbmZpZyBmaWxlLCBpZ25vcmluZy4uLiIpCiAgICAgICAgd2l0aCBvcGVuKCIvbWlzYy9kaXNrMS9saWdodHRwZF96dHAuY29uZiIsInciKSBhcyBsaWdodHRwZF9jb25maWc6CiAgICAgICAgICAgICAgICBsaWdodHRwZF9jb25maWcud3JpdGVsaW5lcyhzZWxmLmxpZ2h0dHBkX2NvbmZpZykKCiAgICBkZWYgZ2V0WHJBcmNoKHNlbGYpOgogICAgICAgICMgR2V0IHRoZSBjdXJyZW50IGFjdGl2ZSBSUCBub2RlLW5hbWUKICAgICAgICBleGVjX2NtZCA9ICJzaG93IHZlcnNpb24iCiAgICAgICAgc2hvd192ZXJzaW9uID0gc2VsZi54ckNMSShjbWQ9ZXhlY19jbWQpCgogICAgICAgIGlmIHNob3dfdmVyc2lvblsic3RhdHVzIl0gPT0gImVycm9yIjoKICAgICAgICAgICAgIHNlbGYuc3lzbG9nZ2VyLmluZm8oIkZhaWxlZCB0byBnZXQgc2hvdyAgdmVyc2lvbiBvdXRwdXQgZnJvbSBYUiIpCiAgICAgICAgICAgICByZXR1cm4geyJzdGF0dXMiIDogImVycm9yIiwgIm91dHB1dCI6ICIiLCAiZXJyb3IiOiAiRmFpbGVkIHRvIGdldCBzaG93ICB2ZXJzaW9uIG91dHB1dCBmcm9tIFhSIn0KICAgICAgICBlbHNlOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICB4cl9hcmNoX21hcmtlciA9IHNob3dfdmVyc2lvblsib3V0cHV0Il1bMF0uc3BsaXQoIiAiKVstMTpdWzBdCiAgICAgICAgICAgICAgICBpZiB4cl9hcmNoX21hcmtlciA9PSAiTE5UIjoKICAgICAgICAgICAgICAgICAgICByZXR1cm4geyJzdGF0dXMiOiAic3VjY2VzcyIsICJvdXRwdXQiOiAiWFItTE5UIiwgImVycm9yIjogIiJ9CiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHJldHVybiB7InN0YXR1cyI6ICJzdWNjZXNzIiwgIm91dHB1dCI6ICJYUiIsICJlcnJvciI6ICIifQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBzZWxmLnN5c2xvZ2dlci5pbmZvKCJGYWlsZWQgdG8gZ2V0IEFjdGl2ZSBSUCBmcm9tIHNob3cgcmVkdW5kYW5jeSBzdW1tYXJ5IG91dHB1dCIpCiAgICAgICAgICAgICAgICByZXR1cm4geyJzdGF0dXMiIDogImVycm9yIiwgIm91dHB1dCIgOiAiIiwgImVycm9yIjogc3RyKGUpfQoKCgogICAgZGVmIHhyQ0xJKHNlbGYsIGNtZCk6CiAgICAgICAgY21kID0gJ3NvdXJjZSAvcGtnL2V0Yy94cl9zdGFydHVwX2VudnMuc2ggJiYgZXhwb3J0IFBBVEg9L3BrZy9zYmluOi9wa2cvYmluOiR7UEFUSH0gJiYgaXAgbmV0bnMgZXhlYyB4cm5ucyAvcGtnL2Jpbi94cl9jbGkgLW4gIiVzIicgJSBjbWQKICAgICAgICBwcm9jZXNzID0gc3VicHJvY2Vzcy5Qb3BlbihjbWQsIHN0ZG91dD1zdWJwcm9jZXNzLlBJUEUsIHNoZWxsPVRydWUpCiAgICAgICAgb3V0LCBlcnIgPSBwcm9jZXNzLmNvbW11bmljYXRlKCkKICAgICAgICBpZiBwcm9jZXNzLnJldHVybmNvZGU6CiAgICAgICAgICAgIHN0YXR1cyA9ICJlcnJvciIKICAgICAgICAgICAgb3V0cHV0ID0gIkZhaWxlZCB0byBnZXQgY29tbWFuZCBvdXRwdXQiCiAgICAgICAgZWxzZToKICAgICAgICAgICAgc3RhdHVzID0gInN1Y2Nlc3MiCiAgICAgICAgICAgIG91dHB1dF9saXN0ID0gW10gCiAgICAgICAgICAgIG91dHB1dCA9ICIiCiAgICAgICAgICAgIGZvciBsaW5lIGluIG91dC5zcGxpdGxpbmVzKCk6CiAgICAgICAgICAgICAgICBmaXhlZF9saW5lID0gbGluZS5yZXBsYWNlKCJcbiIsICIgIikuc3RyaXAoKQogICAgICAgICAgICAgICAgb3V0cHV0X2xpc3QuYXBwZW5kKGZpeGVkX2xpbmUpCiAgICAgICAgICAgICAgICBpZiAiJSBJbnZhbGlkIGlucHV0IGRldGVjdGVkIGF0ICdeJyBtYXJrZXIuIiBpbiBmaXhlZF9saW5lOgogICAgICAgICAgICAgICAgICAgIHN0YXR1cyA9ICJlcnJvciIKICAgICAgICAgICAgICAgIG91dHB1dCA9IGZpbHRlcihOb25lLCBvdXRwdXRfbGlzdCkgICMgUmVtb3ZpbmcgZW1wdHkgaXRlbXMgCiAgICAgICAgcmV0dXJuIHsic3RhdHVzIjogc3RhdHVzLCAib3V0cHV0Ijogb3V0cHV0fSAKCgoKICAgIGRlZiBydW5fYmFzaChzZWxmLCBjbWQ9Tm9uZSwgdnJmPSJnbG9iYWwtdnJmIiwgcGlkPTEpOgogICAgICAgIHdpdGggb3BlbihzZWxmLmdldF9uZXRuc19wYXRoKG5zbmFtZT12cmYsbnNwaWQ9cGlkKSkgYXMgZmQ6CiAgICAgICAgICAgIHNlbGYuc2V0bnMoZmQsIENMT05FX05FV05FVCkKCiAgICAgICAgICAgIGlmIHNlbGYuZGVidWc6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5kZWJ1ZygiYmFzaCBjbWQgYmVpbmcgcnVuOiAiK2NtZCkKICAgICAgICAgICAgIyMgSW4gWFIgdGhlIGRlZmF1bHQgc2hlbGwgaXMgYmFzaCwgaGVuY2UgdGhlIG5hbWUKICAgICAgICAgICAgaWYgY21kIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgcHJvY2VzcyA9IHN1YnByb2Nlc3MuUG9wZW4oY21kLCBzdGRvdXQ9c3VicHJvY2Vzcy5QSVBFLCBzdGRlcnI9c3VicHJvY2Vzcy5QSVBFLCBzaGVsbD1UcnVlKQogICAgICAgICAgICAgICAgb3V0LCBlcnIgPSBwcm9jZXNzLmNvbW11bmljYXRlKCkKICAgICAgICAgICAgICAgIGlmIHNlbGYuZGVidWc6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZGVidWcoIm91dHB1dDogIitvdXQpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZGVidWcoImVycm9yOiAiK2VycikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYuc3lzbG9nZ2VyLmluZm8oIk5vIGJhc2ggY29tbWFuZCBwcm92aWRlZCIpCiAgICAgICAgICAgICAgICByZXR1cm4geyJzdGF0dXMiIDogMSwgIm91dHB1dCIgOiAiIiwgImVycm9yIiA6ICJObyBiYXNoIGNvbW1hbmQgcHJvdmlkZWQifQoKICAgICAgICAgICAgc3RhdHVzID0gcHJvY2Vzcy5yZXR1cm5jb2RlCgogICAgICAgICAgICByZXR1cm4geyJzdGF0dXMiIDogc3RhdHVzLCAib3V0cHV0IiA6IG91dCwgImVycm9yIiA6IGVycn0KCgogICAgZGVmIHNldHVwX2h0dHBfc2VydmVyKHNlbGYsIHBvcnQ9ODA4MCwgc2VydmVyX3Jvb3Q9Ii9taXNjL2Rpc2sxL3p0cCIsIHBlcnNpc3RhbmNlPUZhbHNlKToKICAgICAgICBzZWxmLnNldF9saWdodHRwZF9jb25maWcocG9ydD1wb3J0LCBzZXJ2ZXJfcm9vdD1zZXJ2ZXJfcm9vdCkKICAgICAgICBzZWxmLnBlcnNpc3RhbmNlID0gcGVyc2lzdGFuY2UKICAgICAgICBpZiBzZWxmLnhyX2FyY2ggPT0gIlhSLUxOVCI6CiAgICAgICAgICAgIHNlbGYubGlnaHR0cGRfc2VydmljZSA9IExJR0hUVFBEX1NZU1RFTUQKICAgICAgICAgICAgc2VsZi5zZXJ2aWNlX2ZpbGU9Ii9ldGMvc3lzdGVtZC9zeXN0ZW0vbGlnaHR0cGRfenRwLnNlcnZpY2UiCiAgICAgICAgICAgIHNlbGYubG9hZF9zZXJ2aWNlPSJzeXN0ZW1jdGwgZGFlbW9uLXJlbG9hZCIKICAgICAgICAgICAgc2VsZi5wZXJzaXN0YW5jZT0ic3lzdGVtY3RsIGVuYWJsZSBsaWdodHRwZF96dHAuc2VydmljZSIKICAgICAgICAgICAgc2VsZi5yZW1vdmVfcGVyc2lzdGFuY2U9InN5c3RlbWN0bCBkaXNhYmxlIGxpZ2h0dHBkX3p0cC5zZXJ2aWNlIgogICAgICAgICAgICBzZWxmLnN0YXJ0X3NlcnZpY2VfY21kID0ic3lzdGVtY3RsIHN0YXJ0IGxpZ2h0dHBkX3p0cCIKICAgICAgICAgICAgc2VsZi5zdG9wX3NlcnZpY2VfY21kID0gInN5c3RlbWN0bCBzdG9wIGxpZ2h0dHBkX3p0cCIKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLmxpZ2h0dHBkX3NlcnZpY2UgPSBMSUdIVFRQRF9TWVNWSU5JVAogICAgICAgICAgICBzZWxmLnNlcnZpY2VfZmlsZT0iL2V0Yy9pbml0LmQvbGlnaHR0cGRfenRwIgogICAgICAgICAgICBzZWxmLnBlcnNpc3RhbmNlPSJjaGtjb25maWcgLS1hZGQgbGlnaHR0cGRfenRwIgogICAgICAgICAgICBzZWxmLnJlbW92ZV9wZXJzaXN0YW5jZT0iY2hrY29uZmlnIC0tZGVsIGxpZ2h0dHBkX3p0cCIKICAgICAgICAgICAgc2VsZi5sb2FkX3NlcnZpY2U9ImNobW9kICt4IC9ldGMvaW5pdC5kL2xpZ2h0dHBkX3p0cCIKICAgICAgICAgICAgc2VsZi5zdGFydF9zZXJ2aWNlX2NtZCA9InNlcnZpY2UgbGlnaHR0cGRfenRwIHN0YXJ0IgogICAgICAgICAgICBzZWxmLnN0b3Bfc2VydmljZV9jbWQgPSAic2VydmljZSBsaWdodHRwZF96dHAgc3RvcCIKICAgICAgICAKCiAgICAgICAgdHJ5OgogICAgICAgICAgICB3aXRoIG9wZW4oc2VsZi5zZXJ2aWNlX2ZpbGUsInciKSBhcyBzZXJ2aWNlX2ZpbGU6CiAgICAgICAgICAgICAgICBzZXJ2aWNlX2ZpbGUud3JpdGVsaW5lcyhzZWxmLmxpZ2h0dHBkX3NlcnZpY2UpCgogICAgICAgICAgICBjbWRfcnVuID0gc2VsZi5ydW5fYmFzaChzZWxmLmxvYWRfc2VydmljZSkKICAgICAgICAgICAgaWYgbm90IGNtZF9ydW5bInN0YXR1cyJdOgogICAgICAgICAgICAgICAgc2VsZi5zeXNsb2dnZXIuaW5mbygiTGlnaHR0cGQgc2VydmljZSBzZXQgdXAgc3VjY2Vzc2Z1bGx5IikKICAgICAgICAgICAgICAgIGlmIHNlbGYucGVyc2lzdGFuY2U6CiAgICAgICAgICAgICAgICAgICAgY21kX3J1biA9IHNlbGYucnVuX2Jhc2goc2VsZi5wZXJzaXN0YW5jZSkKICAgICAgICAgICAgICAgICAgICBpZiBub3QgY21kX3J1blsic3RhdHVzIl06CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc3lzbG9nZ2VyLmluZm8oIkxpZ2h0dHBkIHNlcnZpY2Ugc2V0IHVwIHRvIHJ1biBwZXJzaXN0ZW50bHkiKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc3lzbG9nZ2VyLmluZm8oIkZhaWxlZCB0byBzZXR1cCBsaWdodHRwZCBzZXJ2aWNlIHBlcnNpc3RlbnRseSIpCiAgICAgICAgICAgICAgICByZXR1cm57InN0YXR1cyI6ICJzdWNjZXNzIn0KICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYuc3lzbG9nZ2VyLmluZm8oIkZhaWxlZCB0byBzZXR1cCBsaWdodHRwZCBzZXJ2aWNlIikKICAgICAgICAgICAgICAgIHJldHVybnsic3RhdHVzIjogImVycm9yIn0KICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYuc3lzbG9nZ2VyLmluZm8oIkZhaWxlZCB0byBjcmVhdGUgbGlnaHR0cGQgc2VydmljZSBmaWxlLCBlcnJvcjogIitzdHIoZSkpCiAgICAgICAgICAgIHJldHVybnsic3RhdHVzIjogImVycm9yIn0KCgogICAgZGVmIHJlbW92ZV9odHRwX3NlcnZlcihzZWxmKToKICAgICAgICBpZiBzZWxmLnBlcnNpc3RhbmNlOgogICAgICAgICAgICBjbWRfcnVuID0gc2VsZi5ydW5fYmFzaChzZWxmLnJlbW92ZV9wZXJzaXN0YW5jZSkKICAgICAgICAgICAgaWYgbm90IGNtZF9ydW5bInN0YXR1cyJdOgogICAgICAgICAgICAgICAgc2VsZi5zeXNsb2dnZXIuaW5mbygiTGlnaHR0cGQgc2VydmljZSBwZXJzaXN0YW5jZSBkaXNhYmxlZCIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzZWxmLnN5c2xvZ2dlci5pbmZvKCJGYWlsZWQgdG8gZGlzYWJsZSBsaWdodHRwZCBzZXJ2aWNlIHBlcnNpc3RhbmNlIikKICAgICAgICAjUmVtb3ZlIHRoZSBodHRwZCBzZXJ2ZXIgY29uZmlncwogICAgICAgIHRyeToKICAgICAgICAgICAgb3MucmVtb3ZlKHNlbGYuc2VydmljZV9maWxlKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5zeXNsb2dnZXIuaW5mbygiRmFpbGVkIHRvIHJlbW92ZSBsaWdodHRwZF96dHAgc2VydmljZSBmaWxlLCBpZ25vcmluZy4uLiIpCgogICAgZGVmIGNoZWNrX2h0dHBkX3NlcnZlcihzZWxmKToKICAgICAgICAjIENoZWNrIGlmIHRoZSBpbnRlbmRlZCBwb3J0IGlzIG9wZW4KICAgICAgICB3aXRoIGNsb3Npbmcoc29ja2V0LnNvY2tldChzb2NrZXQuQUZfSU5FVCwgc29ja2V0LlNPQ0tfU1RSRUFNKSkgYXMgc29jazoKICAgICAgICAgICAgaWYgc29jay5jb25uZWN0X2V4KCgiMTI3LjAuMC4xIiwgc2VsZi5odHRwZF9wb3J0KSkgPT0gMDoKICAgICAgICAgICAgICAgIHNlbGYuc3lzbG9nZ2VyLmluZm8oIkxpZ2h0dHBkIFBvcnQgaXMgb3Blbiwgc2VydmVyIGlzIHJ1bm5pbmciKQogICAgICAgICAgICAgICAgcmV0dXJuIHsic3RhdHVzIjogInN1Y2Nlc3MifQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5zeXNsb2dnZXIuaW5mbygiTGlnaHR0cGQgUG9ydCBpcyBub3Qgb3Blbiwgc2VydmVyIG5vdCBydW5uaW5nIikKICAgICAgICAgICAgICAgIHJldHVybiB7InN0YXR1cyI6ICJlcnJvciJ9CgoKICAgIGRlZiBodHRwX3NlcnZlcl9hY3Rpb24oc2VsZiwgYWN0aW9uPU5vbmUpOgogICAgICAgIGlmIGFjdGlvbiBpcyBOb25lOgogICAgICAgICAgICBzZWxmLnN5c2xvZ2dlci5pbmZvKCJObyBhY3Rpb24gc3BlY2lmaWVkLCBza2lwcGluZy4uLiIpCiAgICAgICAgICAgIHJldHVybiB7InN0YXR1cyI6ICJlcnJvciJ9CiAgICAgICAgZWxpZiBhY3Rpb24gPT0gInN0YXJ0IjoKICAgICAgICAgICAgc2VsZi5zeXNsb2dnZXIuaW5mbygiU3RhcnRpbmcgTGlnaHR0cGQgc2VydmVyIikKICAgICAgICAgICAgY21kX3J1biA9IHNlbGYucnVuX2Jhc2goc2VsZi5zdGFydF9zZXJ2aWNlX2NtZCkKICAgICAgICAgICAgaWYgbm90IGNtZF9ydW5bInN0YXR1cyJdOgogICAgICAgICAgICAgICAgc2VsZi5zeXNsb2dnZXIuaW5mbygiTGlnaHR0cGQgc2VydmljZSBzdGFydGVkIikKICAgICAgICAgICAgICAgIHNlcnZlcl9jaGVjayA9IHNlbGYuY2hlY2tfaHR0cGRfc2VydmVyKCkKICAgICAgICAgICAgICAgIGlmIHNlcnZlcl9jaGVja1sic3RhdHVzIl0gPT0gImVycm9yIjoKICAgICAgICAgICAgICAgICAgICByZXR1cm4geyJzdGF0dXMiOiAiZXJyb3IifQogICAgICAgICAgICAgICAgZWxzZTogICAgCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsic3RhdHVzIjogInN1Y2Nlc3MifQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5zeXNsb2dnZXIuaW5mbygiRmFpbGVkIHRvIHN0YXJ0IGxpZ2h0dHBkIHNlcnZpY2UiKQogICAgICAgICAgICAgICAgcmV0dXJuIHsic3RhdHVzIjogImVycm9yIn0KICAgICAgICBlbGlmIGFjdGlvbiA9PSAic3RvcCI6CiAgICAgICAgICAgIHNlbGYuc3lzbG9nZ2VyLmluZm8oIlN0b3BwaW5nIExpZ2h0dHBkIHNlcnZlciIpCiAgICAgICAgICAgIGNtZF9ydW4gPSBzZWxmLnJ1bl9iYXNoKHNlbGYuc3RvcF9zZXJ2aWNlX2NtZCkKICAgICAgICAgICAgaWYgbm90IGNtZF9ydW5bInN0YXR1cyJdOgogICAgICAgICAgICAgICAgc2VsZi5zeXNsb2dnZXIuaW5mbygiTGlnaHR0cGQgc2VydmljZSBzdG9wcGVkIikgICAgICAgICAgICAgICAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYuc3lzbG9nZ2VyLmluZm8oIkZhaWxlZCB0byBzdG9wIGxpZ2h0dHBkIHNlcnZpY2UiKQogICAgICAgICAgICAgICAgcmV0dXJuIHsic3RhdHVzIjogImVycm9yIn0KCiAgICAgICAgICAgIAoKCiAgICBkZWYgZGhjcF9zZXJ2ZXJfYWRkcmVzc19wb29sKHNlbGYsIG1pbl9hZGRyPSIiLCBtYXhfYWRkcj0iIiwgZGhjcF92cmY9ImRlZmF1bHQiKToKICAgICAgICBzZWxmLnBvb2xfY29uZmlnID0gIiIiIQogICAgICAgICAgICAgICAgICAgIHBvb2wgdnJmIHtkaGNwX3ZyZn0gaXB2NCBaVFAKICAgICAgICAgICAgICAgICAgICAgYWRkcmVzcy1yYW5nZSB7bWluX2FkZHJ9IHttYXhfYWRkcn0KICAgICAgICAgICAgICAgICAgICAhCiAgICAgICAgICAgICAgICAgICAgIiIiLmZvcm1hdChkaGNwX3ZyZj1kaGNwX3ZyZiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pbl9hZGRyPW1pbl9hZGRyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF4X2FkZHI9bWF4X2FkZHIpCgogICAgICAgIHNlbGYuZGhjcF9zZXJ2ZXJfY29uZmlnX2xpc3QuYXBwZW5kKHNlbGYucG9vbF9jb25maWcpCgogICAgZGVmIGRoY3Bfc2VydmVyX3Byb2ZpbGUoc2VsZiwgYm9vdGZpbGVfdXJsPU5vbmUpOgogICAgICAgIGlmIGJvb3RmaWxlX3VybCBpcyBOb25lOgogICAgICAgICAgICBzZWxmLnN5c2xvZ2dlci5pbmZvKCJib290ZmlsZV91cmwgbm90IHNwZWNpZmllZCwgYWJvcnRpbmcuLi4iKQogICAgICAgICAgICByZXR1cm57InN0YXR1cyI6ICJlcnJvciJ9CgogICAgICAgIHNlbGYuZGhjcF9zZXJ2ZXJfcHJvZmlsZV9jZmcgPSAiIiIKICAgICAgICAgICAgICAgICAgICBkaGNwIGlwdjQKICAgICAgICAgICAgICAgICAgICAgcHJvZmlsZSB6dHAgc2VydmVyCiAgICAgICAgICAgICAgICAgICAgICBsZWFzZSBpbmZpbml0ZQogICAgICAgICAgICAgICAgICAgICAgYm9vdGZpbGUgIntib290ZmlsZV91cmx9IgogICAgICAgICAgICAgICAgICAgICAgcG9vbCBaVFAKICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbiA0MyBoZXggMDEwYTY1Nzg3MjJkNjM2ZjZlNjY2OTY3MDIwMTAwCiAgICAgICAgICAgICAgICAgICAgICIiIi5mb3JtYXQoYm9vdGZpbGVfdXJsPWJvb3RmaWxlX3VybCkKICAgICAgICBzZWxmLmRoY3Bfc2VydmVyX2NvbmZpZ19saXN0LmFwcGVuZChzZWxmLmRoY3Bfc2VydmVyX3Byb2ZpbGVfY2ZnKQogICAgICAgIHJldHVybnsic3RhdHVzIjogInN1Y2Nlc3MifQoKCiAgICBkZWYgZGhjcF9zZXJ2ZXJfaW50ZXJmYWNlKHNlbGYsIGJpbmRfaW50Zj1Ob25lLCBkaGNwX3NlcnZlcl9pcD1Ob25lLCBkaGNwX3NlcnZlcl9pcF9uZXRtYXNrPSIvMzAiKToKICAgCiAgICAgICAgaWYgYmluZF9pbnRmIGlzIE5vbmU6CiAgICAgICAgICAgIHNlbGYuc3lzbG9nZ2VyLmluZm8oIk5vIGludGVyZmFjZSBwcm92aWRlZCwgc2tpcHBpbmcuLi4iKQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgaWYgZGhjcF9zZXJ2ZXJfaXAgaXMgTm9uZToKICAgICAgICAgICAgc2VsZi5zeXNsb2dnZXIuaW5mbygiTm8gZGhjcF9zZXJ2ZXJfaXAgcHJvdmlkZWQsIHNraXBwaW5nLi4uIikKICAgICAgICAgICAgcmV0dXJuCgoKICAgICAgICBpbnRmX2JpbmRfbGlzdD0iIgoKICAgICAgICBkaGNwX3NlcnZlcl9oZWFkZXJfY2ZnID0gIiFcbmRoY3AgaXB2NFxuIgoKICAgICAgICBpbnRmX2JpbmRfbGlzdD1bZGhjcF9zZXJ2ZXJfaGVhZGVyX2NmZ10KCiAgICAgICAgI2ZvciBpbnRlcmZhY2UgaW4gaW50Zl9saXN0OgogICAgICAgICMgICAgaW50Zl9iaW5kPSIgIGludGVyZmFjZSAiK3N0cihpbnRlcmZhY2UpKyIgc2VydmVyIHByb2ZpbGUgenRwXG4iICAgICAgCiAgICAgICAgIyAgICBpbnRmX2JpbmRfbGlzdC5hcHBlbmQoaW50Zl9iaW5kKQogICAgICAgIGludGZfYmluZD0iICBpbnRlcmZhY2UgIitzdHIoYmluZF9pbnRmKSsiIHNlcnZlciBwcm9maWxlIHp0cFxuIgogICAgICAgIGludGZfYmluZF9saXN0LmFwcGVuZChpbnRmX2JpbmQpCiAgICAgICAgZW5kX21hcmtlciA9ICIhXG4iCiAgICAgICAgaW50Zl9iaW5kX2xpc3QuYXBwZW5kKGVuZF9tYXJrZXIpCiAgICAgICAgICAgIAogICAgICAgIGRoY3Bfc2VydmVyX2ludGZfYmluZCA9ICcnLmpvaW4oaW50Zl9iaW5kX2xpc3QpCiAgICAgICAgcmVzdWx0ID0gc2VsZi54cmFwcGx5X3N0cmluZyhkaGNwX3NlcnZlcl9pbnRmX2JpbmQpCiAgICAgICAgaWYgcmVzdWx0WyJzdGF0dXMiXSA9PSAiZXJyb3IiOgogICAgICAgICAgICBzZWxmLnN5c2xvZ2dlci5pbmZvKCJGYWlsZWQgdG8gYXBwbHkgREhDUCBpbnRlcmZhY2UgYmluZCBjb25maWcgdG8gcm91dGVyICVzIitqc29uLmR1bXBzKHJlc3VsdCkpCgogICAgICAgICMgQ29uZmlndXJlIHRoZSBESENQIFNlcnZlciBJUCBvbiB0aGUgaW50ZXJmYWNlIAogICAgICAgIGRoY3Bfc2VydmVyX2ludGZfY2ZnID0gImludGVyZmFjZSAiK3N0cihiaW5kX2ludGYpKyJcbiAgaXB2NCBhZGRyZXNzICIrc3RyKGRoY3Bfc2VydmVyX2lwKStzdHIoZGhjcF9zZXJ2ZXJfaXBfbmV0bWFzaykrIlxuICBubyBzaHV0ZG93blxuIVxuIgogICAgICAgIHJlc3VsdCA9IHNlbGYueHJhcHBseV9zdHJpbmcoZGhjcF9zZXJ2ZXJfaW50Zl9jZmcpCiAgICAgICAgaWYgcmVzdWx0WyJzdGF0dXMiXSA9PSAiZXJyb3IiOgogICAgICAgICAgICBzZWxmLnN5c2xvZ2dlci5pbmZvKCJGYWlsZWQgdG8gYXBwbHkgREhDUCBpbnRlcmZhY2UgYmluZCBjb25maWcgdG8gcm91dGVyICVzIitqc29uLmR1bXBzKHJlc3VsdCkpCiAgICAgICAgcmV0dXJuIHJlc3VsdAoKCiAgICBkZWYgY29uZmlnX2RoY3Bfc2VydmVyKHNlbGYpOgogICAgICAgIHNlbGYuZGhjcF9zZXJ2ZXJfY29uZmlnID0gJycuam9pbihzZWxmLmRoY3Bfc2VydmVyX2NvbmZpZ19saXN0KQoKICAgICAgICB3aXRoIHRlbXBmaWxlLk5hbWVkVGVtcG9yYXJ5RmlsZShkZWxldGU9VHJ1ZSkgYXMgZjoKICAgICAgICAgICAgZi53cml0ZSgiJXMiICUgc2VsZi5kaGNwX3NlcnZlcl9jb25maWcpCiAgICAgICAgICAgIGYuZmx1c2goKQogICAgICAgICAgICBmLnNlZWsoMCkKICAgICAgICAgICAgcmVzdWx0ID0gc2VsZi54cmFwcGx5KGYubmFtZSkKCiAgICAgICAgaWYgcmVzdWx0WyJzdGF0dXMiXSA9PSAiZXJyb3IiOgoKICAgICAgICAgICAgc2VsZi5zeXNsb2dnZXIuaW5mbygiRmFpbGVkIHRvIGFwcGx5IERIQ1Agc2VydmVyIGNvbmZpZyB0byByb3V0ZXIgJXMiK2pzb24uZHVtcHMocmVzdWx0KSkKCiAgICAgICAgcmV0dXJuIHJlc3VsdAoKCgogICAgZGVmIHJlbW92ZV9kaGNwX3NlcnZlcl9jb25maWcoc2VsZiwgZGhjcF92cmY9ImRlZmF1bHQiLCBiaW5kX2ludGY9Tm9uZSk6CiAgICAgICAgaWYgYmluZF9pbnRmIGlzIG5vdCBOb25lOgogICAgICAgICAgICBub19iaW5kX2ludGY9IiFcbmludGVyZmFjZSAiK3N0cihiaW5kX2ludGYpKyJcbiAgbm8gaXB2NCBhZGRyZXNzXG4hIgogICAgICAgIGVsc2U6CiAgICAgICAgICAgIG5vX2JpbmRfaW50Zj0iIgoKICAgICAgICBub19kaGNwX3NlcnZlcj0iIiIKICAgICAgICAgICAgICAgICAgICAgICAgIQogICAgICAgICAgICAgICAgICAgICAgICBubyBkaGNwIGlwdjQKICAgICAgICAgICAgICAgICAgICAgICAgIQogICAgICAgICAgICAgICAgICAgICAgICBubyBwb29sIHZyZiB7ZGhjcF92cmZ9IGlwdjQgWlRQCiAgICAgICAgICAgICAgICAgICAgICAgICIiIi5mb3JtYXQoZGhjcF92cmY9ZGhjcF92cmYpCgogICAgICAgIG5vX2NvbmZpZz0iIi5qb2luKFtub19iaW5kX2ludGYsIG5vX2RoY3Bfc2VydmVyXSkKICAgICAgICB3aXRoIHRlbXBmaWxlLk5hbWVkVGVtcG9yYXJ5RmlsZShkZWxldGU9VHJ1ZSkgYXMgZjoKICAgICAgICAgICAgZi53cml0ZSgiJXMiICUgbm9fY29uZmlnKQogICAgICAgICAgICBmLmZsdXNoKCkKICAgICAgICAgICAgZi5zZWVrKDApCiAgICAgICAgICAgIHJlc3VsdCA9IHNlbGYueHJhcHBseShmLm5hbWUpCgogICAgICAgIGlmIHJlc3VsdFsic3RhdHVzIl0gPT0gImVycm9yIjoKCiAgICAgICAgICAgIHNlbGYuc3lzbG9nZ2VyLmluZm8oIkZhaWxlZCB0byBhcHBseSBESENQIHNlcnZlciBjb25maWcgdG8gcm91dGVyICVzIitqc29uLmR1bXBzKHJlc3VsdCkpCgogICAgICAgIHJldHVybiByZXN1bHQKCgoKCmlmIF9fbmFtZV9fID09ICJfX21haW5fXyI6CgogICAgIyBDcmVhdGUgYW4gT2JqZWN0IG9mIHRoZSBjaGlsZCBjbGFzcywgc3lzbG9nIHBhcmFtZXRlcnMgYXJlIG9wdGlvbmFsLiAKICAgICMgSWYgbm90aGluZyBpcyBzcGVjaWZpZWQsIHRoZW4gbG9nZ2luZyB3aWxsIGhhcHBlbiB0byBsb2NhbCBsb2cgcm90YXRlZCBmaWxlLgogICAgcGFyc2VyID0gYXJncGFyc2UuQXJndW1lbnRQYXJzZXIoKQogICAgcGFyc2VyLmFkZF9hcmd1bWVudCgnLWknLCAnLS1pZ25vcmUtZGhjcC1zZXJ2ZXInLCBhY3Rpb249J3N0b3JlX3RydWUnLCBkZXN0PSdpZ25vcmVfZGhjcF9zZXJ2ZXInLAogICAgICAgICAgICAgICAgICAgIGhlbHA9J1NraXAgREhDUCBzZXJ2ZXIgY29uZmlndXJhdGlvbiBhbmQgb25seSBtYW5hZ2UgdGhlIGh0dHAgc2VydmVyJykKICAgIHBhcnNlci5hZGRfYXJndW1lbnQoJy1iJywgJy0tcGVyc2lzdGVudC1odHRwZC1zZXJ2aWNlJywgYWN0aW9uPSdzdG9yZV90cnVlJywgZGVzdD0ncGVyc2lzdGVudF9odHRwZF9zZXJ2aWNlJywKICAgICAgICAgICAgICAgICAgICBoZWxwPSdJZiBvcHRpb24gaXMgc3BlY2lmaWVkLCBodHRwZCBzZXJ2aWNlIHdpbGwgYmUgbWFkZSBwZXJzaXN0ZW50IGFjcm9zcyByZWxvYWRzJykKICAgIHBhcnNlci5hZGRfYXJndW1lbnQoJy1kJywgJy0tZGhjcC1pbnRmJywgZGVzdD0nZGhjcF9pbnRmJywgZGVmYXVsdD0iIiwKICAgICAgICAgICAgICAgICAgICBoZWxwPSdTcGVjaWZ5IHRoZSBpbnRlcmZhY2UgdG8gZW5hYmxlIHRoZSBESENQIHNlcnZlciBvbi4gSWYgbm90IHNwZWNpZmllZCwgb25seSB0aGUgREhDUCBzZXJ2ZXIgd2lsbCBiZSBjb25maWd1cmVkLCB3aXRob3V0IGJpbmRpbmcgdG8gYW55IGludGVyZmFjZScpCiAgICBwYXJzZXIuYWRkX2FyZ3VtZW50KCctcCcsJy0taHR0cGQtcG9ydCcsIGRlc3Q9J2h0dHBkX3BvcnQnLCBkZWZhdWx0PTgwODAsCiAgICAgICAgICAgICAgICAgICAgaGVscD0nU3BlY2lmeSBwb3J0IG9uIHdoaWNoIHRoZSBodHRwZCBzZXJ2ZXIgd2lsbCBydW4nKQogICAgcGFyc2VyLmFkZF9hcmd1bWVudCgnLXInLCctLXNlcnZlci1yb290JywgYWN0aW9uPSdhcHBlbmQnLCBkZXN0PSdodHRwZF9zZXJ2ZXJfcm9vdCcsIGRlZmF1bHQ9Ii9taXNjL2Rpc2sxL3p0cCIsCiAgICAgICAgICAgICAgICAgICAgaGVscD0nU3BlY2lmeSByb290IGRpcmVjdG9yeSBmb3IgdGhlIGh0dHBkIHNlcnZlcicpCiAgICBwYXJzZXIuYWRkX2FyZ3VtZW50KCctYScsJy0tYWN0aW9uJywgZGVzdD0nYWN0aW9uJywgZGVmYXVsdD0ic3RhcnQiLAogICAgICAgICAgICAgICAgICAgICAgICBoZWxwPSdBY3Rpb24gb3B0aW9ucyBhcmUgInN0YXJ0IiBhbmQgInN0b3AiJykKICAgIHBhcnNlci5hZGRfYXJndW1lbnQoJy1jJywgJy0tZGhjcC1jbGllbnQtaXAnLCBkZXN0PSdkaGNwX2NsaWVudF9pcCcsIGRlZmF1bHQ9IjEuMS4xLjIiLAogICAgICAgICAgICAgICAgICAgICAgICBoZWxwPSdTcGVjaWZ5IHRoZSBkZWZhdWx0IGRoY3AgY2xpZW50IGlwIGZvciB0aGUgWlRQIG5vZGUnKQogICAgcGFyc2VyLmFkZF9hcmd1bWVudCgnLXMnLCAnLS1kaGNwLXNlcnZlci1pcCcsIGRlc3Q9J2RoY3Bfc2VydmVyX2lwJywgZGVmYXVsdD0iMS4xLjEuMSIsCiAgICAgICAgICAgICAgICAgICAgICAgIGhlbHA9J1NwZWNpZnkgdGhlIGRlZmF1bHQgZGhjcCBzZXJ2ZXIgaXAgZm9yIHRoZSBaVFAgbm9kZScpCiAgICBwYXJzZXIuYWRkX2FyZ3VtZW50KCcteicsICctLXp0cC1zY3JpcHQtZmlsZW5hbWUnLCBkZXN0PSd6dHBfc2NyaXB0X2ZpbGVuYW1lJywgZGVmYXVsdD0ienRwX3NjcmlwdC5weSIsCiAgICAgICAgICAgICAgICAgICAgICAgIGhlbHA9J1NwZWNpZnkgdGhlIGZpbGVuYW1lIG9mIHRoZSBaVFAgc2NyaXB0IHRvIGJlIHVzZWQgaW4gYm9vdGZpbGVuYW1lIG9wdGlvbiBmb3IgdGhlIG5leHQgWlRQIG5vZGUnKQogICAgcGFyc2VyLmFkZF9hcmd1bWVudCgnLXYnLCAnLS1kaGNwLXNlcnZlci12cmYnLCBkZXN0PSdkaGNwX3NlcnZlcl92cmYnLCBkZWZhdWx0PSJkZWZhdWx0IiwKICAgICAgICAgICAgICAgICAgICAgICAgaGVscD0nU3BlY2lmeSB0aGUgZGhjcCBzZXJ2ZXIgdnJmJykKCiAgICBhcmdvYmo9IHBhcnNlci5wYXJzZV9hcmdzKCkKCiAgICB6dHBfc2VydmVyID0gU2hpZnRaVFBTZXJ2ZXIoKQoKICAgIGlmIG5vdCBhcmdvYmouaWdub3JlX2RoY3Bfc2VydmVyOgogICAgICAgIHp0cF9zZXJ2ZXIuZGhjcF9zZXJ2ZXJfYWRkcmVzc19wb29sKG1pbl9hZGRyPWFyZ29iai5kaGNwX2NsaWVudF9pcCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXhfYWRkcj1hcmdvYmouZGhjcF9jbGllbnRfaXAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGhjcF92cmY9YXJnb2JqLmRoY3Bfc2VydmVyX3ZyZikKICAgICAgICBwcm9maWxlX3NldHVwID0genRwX3NlcnZlci5kaGNwX3NlcnZlcl9wcm9maWxlKGJvb3RmaWxlX3VybD0iaHR0cDovLyIrc3RyKGFyZ29iai5kaGNwX3NlcnZlcl9pcCkrIjoiK3N0cihhcmdvYmouaHR0cGRfcG9ydCkrIi8iK3N0cihhcmdvYmouenRwX3NjcmlwdF9maWxlbmFtZSkpCiAgICAgICAgaWYgcHJvZmlsZV9zZXR1cFsic3RhdHVzIl0gPT0gImVycm9yIjoKICAgICAgICAgICAgenRwX3NlcnZlci5zeXNsb2dnZXIuaW5mbygiRmFpbGVkIHRvIHNldHVwIERIQ1Agc2VydmVyIHByb2ZpbGUsIGV4aXRpbmcuLi4iKQogICAgICAgICAgICBzeXMuZXhpdCgxKQoKCiAgICAjIE5vdyBzZXR1cCB0aGUgbGlnaHR0cGQgc2VydmVyCgogICAgaHR0cGRfc2VydmVyPXp0cF9zZXJ2ZXIuc2V0dXBfaHR0cF9zZXJ2ZXIocG9ydD1hcmdvYmouaHR0cGRfcG9ydCwgCiAgICAgICAgICAgICAgICAgICAgICBzZXJ2ZXJfcm9vdD1hcmdvYmouaHR0cGRfc2VydmVyX3Jvb3QsCiAgICAgICAgICAgICAgICAgICAgICBwZXJzaXN0YW5jZT1hcmdvYmoucGVyc2lzdGVudF9odHRwZF9zZXJ2aWNlKQogCiAgICBpZiBodHRwZF9zZXJ2ZXJbInN0YXR1cyJdID09ICJzdWNjZXNzIjoKICAgICAgICB6dHBfc2VydmVyLnN5c2xvZ2dlci5pbmZvKCJIdHRwZCBzZXJ2aWNlIHN1Y2Nlc3NmdWxseSBzZXQgdXAiKQogICAgZWxzZToKICAgICAgICB6dHBfc2VydmVyLnN5c2xvZ2dlci5pbmZvKCJGYWlsZWQgdG8gc2V0IHVwIEhUVFBEIHNlcnZlciwgZXhpdGluZy4uLiIpCiAgICAgICAgc3lzLmV4aXQoMSkKCgogICAgIyBCYXNlZCBvbiB0aGUgYWN0aW9uIHNwZWNpZmllZCwgc3RhcnQgb3Igc3RvcCB0aGUgc2VydmljZQoKICAgIGlmIGFyZ29iai5hY3Rpb249PSJzdGFydCI6CiAgICAgICAgaWYgbm90IGFyZ29iai5pZ25vcmVfZGhjcF9zZXJ2ZXI6CiAgICAgICAgICAgIGNvbmZpZ19kaGNwID0genRwX3NlcnZlci5jb25maWdfZGhjcF9zZXJ2ZXIoKQoKICAgICAgICAgICAgaWYgY29uZmlnX2RoY3BbInN0YXR1cyJdID09ICJzdWNjZXNzIjoKICAgICAgICAgICAgICAgIHp0cF9zZXJ2ZXIuc3lzbG9nZ2VyLmluZm8oIkRIQ1Agc2VydmVyIHN1Y2Nlc3NmdWxseSBjb25maWd1cmVkIikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHp0cF9zZXJ2ZXIuc3lzbG9nZ2VyLmluZm8oIkZhaWxlZCB0byBjb25maWd1cmUgREhDUCBzZXJ2ZXIgaW4gWFIsIGV4aXRpbmcuLiIpCiAgICAgICAgICAgICAgICBzeXMuZXhpdCgxKQoKICAgICAgICAgICAgaWYgYXJnb2JqLmRoY3BfaW50ZiAhPSAiIjoKICAgICAgICAgICAgICAgIGJpbmRfZGhjcCA9IHp0cF9zZXJ2ZXIuZGhjcF9zZXJ2ZXJfaW50ZXJmYWNlKGJpbmRfaW50Zj1hcmdvYmouZGhjcF9pbnRmLGRoY3Bfc2VydmVyX2lwPWFyZ29iai5kaGNwX3NlcnZlcl9pcCkKICAgICAgICAgICAgICAgIGlmIGNvbmZpZ19kaGNwWyJzdGF0dXMiXSA9PSAic3VjY2VzcyI6CiAgICAgICAgICAgICAgICAgICAgenRwX3NlcnZlci5zeXNsb2dnZXIuaW5mbygiREhDUCBzZXJ2ZXIgYm91bmQgdG8gaW50ZXJmYWNlczogIitzdHIoYXJnb2JqLmRoY3BfaW50ZikpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHp0cF9zZXJ2ZXIuc3lzbG9nZ2VyLmluZm8oIkZhaWxlZCB0byBiaW5kIERIQ1Agc2VydmVyIHRvIHNwZWNpZmllZCBpbnRlcmZhY2VzLCBleGl0aW5nLi4iKQogICAgICAgICAgICAgICAgICAgIHN5cy5leGl0KDEpCgoKICAgICAgICAjIFN0b3AgYW55IHByZXZpb3VzbHkgcnVubmluZyBpbnN0YW5jZSBvZiB0aGUgaHR0cCBzZXJ2ZXIgYmVmb3JlIHN0YXJ0aW5nIGFnYWluCiAgICAgICAgaHR0cF9zZXJ2ZXJfcnVuID0genRwX3NlcnZlci5odHRwX3NlcnZlcl9hY3Rpb24oYWN0aW9uPSJzdG9wIikKICAgICAgICBodHRwX3NlcnZlcl9ydW4gPSB6dHBfc2VydmVyLmh0dHBfc2VydmVyX2FjdGlvbihhY3Rpb249InN0YXJ0IikKIAogICAgZWxpZiBhcmdvYmouYWN0aW9uID09InN0b3AiOgogICAgICAgIGlmIG5vdCBhcmdvYmouaWdub3JlX2RoY3Bfc2VydmVyOgogICAgICAgICAgICBpZiBhcmdvYmouZGhjcF9pbnRmICE9ICIiOgogICAgICAgICAgICAgICAgY29uZmlnX2RoY3AgPSB6dHBfc2VydmVyLnJlbW92ZV9kaGNwX3NlcnZlcl9jb25maWcoYmluZF9pbnRmPWFyZ29iai5kaGNwX2ludGYpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBjb25maWdfZGhjcCA9IHp0cF9zZXJ2ZXIucmVtb3ZlX2RoY3Bfc2VydmVyX2NvbmZpZygpCgogICAgICAgICAgICBpZiBjb25maWdfZGhjcFsic3RhdHVzIl0gPT0gInN1Y2Nlc3MiOgogICAgICAgICAgICAgICAgenRwX3NlcnZlci5zeXNsb2dnZXIuaW5mbygiREhDUCBzZXJ2ZXIgc3VjY2Vzc2Z1bGx5IHVuY29uZmlndXJlZCIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICB6dHBfc2VydmVyLnN5c2xvZ2dlci5pbmZvKCJGYWlsZWQgdG8gdW5jb25maWd1cmUgREhDUCBzZXJ2ZXIgaW4gWFIsIGV4aXRpbmcuLiIpCiAgICAgICAgICAgICAgICBzeXMuZXhpdCgxKQogIAogICAgICAgIHp0cF9zZXJ2ZXIuaHR0cF9zZXJ2ZXJfYWN0aW9uKGFjdGlvbj0ic3RvcCIpCiAgICAgICAgenRwX3NlcnZlci5yZW1vdmVfaHR0cF9zZXJ2ZXIoKQ=="
import sys, os
sys.path.append("/pkg/bin/")
from ztp_helper import ZtpHelpers
import base64
import json, tempfile
from pprint import pprint


class ZtpFunctions(ZtpHelpers):

    def bootstrap_config(self):
        # The hash for the password in config below translates to "lab"
        # So root-user credentials will be netops/lab
        # This is a sample bootstrap configuration.
        config = """ !
                     username netops
                       group root-lr
                       group cisco-support
                       secret 5 $1$7kTu$zjrgqbgW08vEXsYzUycXw1
                       !
                     !
                     ssh server v2
                     ssh server vrf default
                     !
                     end"""



        with tempfile.NamedTemporaryFile(delete=True) as f:
            f.write("%s" % config)
            f.flush()
            f.seek(0)
            result = self.xrapply(f.name)

        if result["status"] == "error":

            self.syslogger.info("Failed to apply root user to system %s"+json.dumps(result))

        return result


    def decode_and_place_script(self):
    	# Place the ondemand script in hardisk: (/misc/disk1)
        with open('/misc/disk1/shifting_ztp_server.py', 'wb') as ondemandfh:
            ondemandfh.write(base64.standard_b64decode(ondemand_dhcp_http_script_b64))



if __name__ == "__main__":

    ztp_script = ZtpFunctions()

    # Apply the bootstrap configuration
    result = ztp_script.bootstrap_config()
    if result["status"] == "error":
    	ztp_script.syslogger.info("Failed to apply bootstrap_config, exiting...")
    	sys.exit(1)

    ztp_script.decode_and_place_script()

    # Download the ZTP script for the next CSS node based on the known bootfilename
    ztp_script.download_file(file_url=eval(os.environ["new_bootfile_name"]),
                             destination_folder='/misc/disk1/ztp/')
